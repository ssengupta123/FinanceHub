# FinanceHub - Project Finance Management

## Overview
FinanceHub is a production-grade financial and project management application designed to consolidate data from various sources (manual and automated). Its primary purpose is to track project burn rates, resource utilization, financial forecasts, customer experience ratings, and resource costs with robust workflows. The application is tailored to match Excel data structures, including pipeline classifications, VAT categories, billing types, and the Australian Financial Year format (Jul-Jun). It is engineered for deployment on Azure, aiming to provide a comprehensive solution for financial oversight and project management.

## User Preferences
No specific user preferences were provided. The agent should infer best practices for communication, coding style, workflow, and interaction based on the project's technical details and overall goals.

## System Architecture
The application is built with a React + Vite frontend using Tailwind CSS and shadcn/ui for styling, wouter for routing, and TanStack Query for data fetching. The backend is an Express.js server utilizing `express-session` for session-based authentication. PostgreSQL is used for development, with Azure SQL/MSSQL planned for production, managed by Knex.js.

**Key Architectural Decisions:**
- **Modular Monolith:** The project structure is organized into `client/` and `server/` directories, with a `shared/` directory for common schemas (Zod for data validation).
- **Session-Based Authentication & Fine-Grained RBAC:** Employs `express-session` with `connect-pg-simple` for secure, persistent user sessions and `bcryptjs` for password hashing. Fine-grained role-based access control (RBAC) with 5 roles: Admin (superuser), Executive, VAT Lead, Operations, Employee. Permissions are stored in `role_permissions` table (role, resource, action, allowed) and enforced both server-side via `requirePermission` middleware on all API routes, and client-side via `can(resource, action)` function from `useAuth` hook. Admin UI on Administration page provides a permissions matrix editor (per-role toggle for each resource/action) and user role management. Sidebar navigation and action buttons (Add, Edit, Delete) are dynamically hidden based on the user's permissions. Azure AD SSO integration for user authentication and auto-provisioning.
- **Data Model:** Comprehensive Zod schemas define data models for entities such as `employees`, `projects`, `pipelineOpportunities`, `scenarios`, `timesheets`, `costs`, `milestones`, `referenceData`, `cxRatings`, and `resourceCosts`. The database schema is managed by Knex.js with incremental migrations.
- **API Design:** A RESTful API provides endpoints for CRUD operations and specialized queries, with filtering capabilities.
- **UI/UX Design:** Features a modern aesthetic with shadcn/ui components, supporting both dark and light themes. Visualizations are provided by Recharts (Pie, Area, Bar) for dashboards.
- **Financial Logic:** Incorporates Australian FY specific calculations (Jul-Jun), pipeline classifications with associated win probabilities (e.g., C(100%), S(80%)), VAT categories, and distinct billing types (Fixed, T&M, LH). Gross Margin (GM) is a key metric, displayed as both dollar amount and percentage.
- **AI Insights:** Integration with OpenAI for AI-powered analysis across six types (Risk Analysis: Risk Register, Pipeline Risks, Project Risks; Financial Intelligence: Spending Patterns, Financial Advice, Spending Forecast) using streaming responses from GPT-4o-mini.
- **VAT Sales Committee Reports:** Web-based editable interface replicating the PowerPoint VAT SC Report template. Supports 7 VATs (DAFF, SAU, VICGov, DISR, Growth, P&P, Emerging) with tabbed sections for Status Overview, Risks/Issues table, Planner Tasks, and AI Suggestions. All changes are logged with user attribution. AI suggestions pull from existing pipeline_opportunities data to provide strategic advice. Database tables: `vat_reports`, `vat_risks`, `vat_action_items`, `vat_planner_tasks` (with `external_id` for Planner sync), `vat_change_logs`. Includes Microsoft Planner sync via Graph API (client credentials flow) to import/update/remove tasks by external ID, with sync insights and change logging. Per-section RAG status selectors (Open Opps, Big Plays, Account Goals, Relationships, Research) prepopulated from last report.
- **Excel Import System:** Supports bulk data upload from multi-sheet Excel workbooks for Job Status, Staff SOT, Pipeline Revenue, Gross Profit, Personal Hours, Project Hours, CX Master List, Project Resource Cost, Project Resource Cost A&F, and Open Opportunities. It includes robust cross-referencing logic for projects and employees, and handles specific "Reason" entries as "Internal" projects.
- **PPTX VAT Report Import:** Supports uploading VAT SC Report PowerPoint files (.pptx) to bulk-create VAT reports. Parser (`server/pptx-parser.ts`) extracts slide XML to identify VAT groups, parse status summaries from 3-column tables, risks/issues from 11-column tables, and planner tasks from 7-column tables. Endpoints: `POST /api/upload/vat-pptx/preview` and `POST /api/upload/vat-pptx/import`. UI on Data Upload page with preview, VAT selection, date override, and import results display.
- **VAT Target Tracking & Overview:** Per-VAT quarterly financial targets with OK/Good/Great/Amazing tiers for GM Contribution, Revenue, and GM%. Database table: `vat_targets` with tier targets and optional quarterly breakdowns. VAT list is data-driven from `reference_data` (category: `vat_category`). Admin page includes VatFinancialTargetsEditor for managing targets per VAT per FY. VAT Overview page (`/vat-overview`) shows cumulative YTD vs prorated target charts per VAT using Recharts ComposedChart (bars for actuals, dashed lines for tier targets). Tier status badges show performance relative to prorated annual targets. Quarterly actuals computed from `project_monthly` table using FY month mapping (1=Jul through 12=Jun).

- **Feature Request System:** Employee-facing submission form for enhancement requests with admin review workflow. Statuses: Submitted → Under Review → In Progress → Deployed. Admins/Executives can manage requests, create GitHub feature branches (auto-named `feature/fr-{id}-{slug}`), and mark as deployed. All roles can view and submit requests. Database table: `feature_requests`. RBAC resource: `feature_requests` with actions: view, create, edit. Processing workflow: Admin marks "Start Work" which creates a GitHub feature branch, then prompts the Replit AI agent to implement changes, then marks as "Deployed" after merge/deploy.

## External Dependencies
- **PostgreSQL:** Primary database for development and local environments.
- **Azure SQL/MSSQL:** Planned production database environment.
- **OpenAI:** Utilized for AI-powered insights and analysis via Replit AI Integrations.
- **Employment Hero:** External API for daily data synchronization.
- **iTimesheets:** External API for daily timesheet data synchronization.
- **SharePoint:** External API for hourly data synchronization.
- **xlsx (SheetJS):** Excel file parsing for the import system.
- **Azure Active Directory:** For SSO (Single Sign-On) login integration.
- **jsonwebtoken:** JWT validation for SSO token handoff from Launchpad app. Requires `SSO_HANDOFF_SECRET` env var (same value on both Launchpad and FinanceHub). Middleware in `server/index.ts` validates tokens issued by Launchpad with issuer "launchpad", auto-provisions users, creates sessions, and redirects to strip the token from the URL.